<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taken Cafe - Payment - QClub</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #f7f9fc; 
            color: #333; 
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            margin: 0; 
        }
        
        .container { 
            background: white; 
            width: 100%; 
            max-width: 600px; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        
        header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        
        h1 { 
            margin: 0; 
            font-size: 28px; 
            color: #1a1f36; 
        }
        
        .subtitle { 
            color: #697386; 
            margin-top: 5px; 
            font-size: 14px; 
        }
        
        /* JWT Token Section */
        .jwt-section {
            background: #f8f9fc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #5469d4;
        }
        
        .jwt-section h3 {
            font-size: 16px;
            margin: 0 0 12px 0;
            color: #1a1f36;
        }
        
        .jwt-section input {
            width: 100%;
            padding: 12px;
            font-size: 13px;
            border: 2px solid #e6ebf1;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        .jwt-section input:focus {
            outline: none;
            border-color: #5469d4;
            box-shadow: 0 0 0 3px rgba(84, 105, 212, 0.1);
        }
        
        .jwt-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }
        
        .jwt-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* Order Input Section */
        .order-input-section {
            text-align: center;
            padding: 20px 0;
            display: none;
        }
        
        .order-input-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #1a1f36;
        }
        
        .order-input-section input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e6ebf1;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        .order-input-section input:focus {
            outline: none;
            border-color: #5469d4;
            box-shadow: 0 0 0 3px rgba(84, 105, 212, 0.1);
        }
        
        .btn-primary {
            background: #5469d4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: #4053b8;
        }
        
        .btn-primary:disabled {
            background: #9ca9df;
            cursor: not-allowed;
        }
        
        /* Order Details Display */
        .order-details-display {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .order-details-display h3 {
            margin-top: 0;
            font-size: 16px;
            color: #1a1f36;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e6ebf1;
            font-size: 14px;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-weight: 600;
            font-size: 16px;
            color: #1a1f36;
            margin-top: 10px;
            border-top: 2px solid #e6ebf1;
        }
        
        /* Gateway Selection */
        .gateway-selector { 
            margin: 30px 0; 
            text-align: center;
            display: none;
        }
        
        .gateway-selector h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #1a1f36;
        }
        
        .gateway-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .gateway-btn { 
            padding: 15px; 
            border: 2px solid #e6ebf1; 
            background: white; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }
        
        .gateway-btn.active {
            border-color: #5469d4;
            background: #5469d4;
            color: white;
        }
        
        .gateway-btn:hover { 
            border-color: #5469d4; 
        }
        
        .gateway-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fc;
            border-radius: 6px;
            font-size: 14px;
            color: #697386;
        }
        
        #loading { 
            text-align: center; 
            padding: 40px; 
            display: none; 
        }
        
        .spinner { 
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5469d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‚òï Taken Cafe</h1>
        <p class="subtitle">Secure Checkout - QClub Payment</p>
    </header>

    <!-- Error Message Display -->
    <div id="error-message" class="error-message"></div>
    
    <!-- Success Message Display -->
    <div id="success-message" class="success-message"></div>

    <!-- JWT Token Section (Step 1) -->
    <section class="jwt-section">
        <h3>üîê Backend JWT Token</h3>
        <input 
            type="password" 
            id="jwt-token-input" 
            placeholder="Paste your JWT token here" 
            autocomplete="off"
        />
        <div id="jwt-status" class="jwt-status"></div>
    </section>

    <!-- Order ID Input Section (Step 2) -->
    <section id="order-input-section" class="order-input-section">
        <h2>üì¶ Enter Your Order ID</h2>
        <input 
            type="number" 
            id="order-id-input" 
            placeholder="Order ID" 
            min="1" 
            autocomplete="off"
        />
        <button id="load-order-btn" class="btn-primary">Load Order</button>
    </section>

    <!-- Order Details Preview -->
    <div id="order-details-display" class="order-details-display">
        <h3>Order Summary</h3>
        <div id="order-items-list"></div>
        <div class="order-total">
            <span>Total Amount:</span>
            <span id="order-total-amount">$0.00</span>
        </div>
    </div>

    <!-- QClub Payment Section -->
    <section id="payment-section" class="gateway-selector">
        <h2>üí≥ Process Payment with QClub</h2>
        <button id="qclub-pay-btn" class="btn-primary" style="display: none;">
            Complete Payment with QClub
        </button>
        <div id="qclub-info" style="display: none; margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
            <p style="margin: 0; font-size: 14px; color: #1565c0;">
                ‚ÑπÔ∏è You will be redirected to QClub payment form to complete your purchase.
            </p>
        </div>
    </section>

    <!-- Loading Indicator -->
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">Processing...</p>
    </div>
</div>

<script>
    // ========== CONFIGURATION ==========
    const BACKEND_BASE_URL = 'https://livekit-mobile.linkedinwriter.io';
    const API_BASE_URL = `${BACKEND_BASE_URL}/api`;
    
    // ========== STATE VARIABLES ==========
    let currentOrder = null;
    let ORDER_ID = null;
    let jwtToken = null;
    let isAuthenticated = false;
    
    // ========== MAIN FUNCTIONS ==========
    
    /**
     * Handle JWT token input - just store it when user pastes
     */
    function handleJWTToken() {
        const jwtInput = document.getElementById('jwt-token-input');
        const jwtStatus = document.getElementById('jwt-status');
        const token = jwtInput.value.trim();
        
        if (!token) {
            jwtStatus.textContent = '‚ö†Ô∏è Please paste your JWT token';
            jwtStatus.classList.add('error');
            jwtStatus.style.display = 'block';
            isAuthenticated = false;
            return;
        }
        
        // Store token
        jwtToken = token;
        isAuthenticated = true;
        
        jwtStatus.textContent = '‚úÖ Token saved! Enter Order ID below.';
        jwtStatus.classList.remove('error');
        jwtStatus.style.display = 'block';
        
        console.log('‚úÖ JWT Token stored');
        
        // Show order input section
        document.getElementById('order-input-section').style.display = 'block';
    }
    
    /**
     * Load order details from backend API
     */
    async function loadOrderById(orderId) {
        const loadingSection = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const loadBtn = document.getElementById('load-order-btn');
        const orderDetailsDisplay = document.getElementById('order-details-display');
        
        try {
            if (!jwtToken) {
                showError('JWT token not set. Please paste your token above.');
                return;
            }
            
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            loadingSection.style.display = 'block';
            errorDiv.style.display = 'none';
            
            const endpoint = `${API_BASE_URL}/orders/${orderId}`;
            console.log(`üîç API Request: GET ${endpoint}`);
            
            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                }
            });
            
            console.log(`üìä Response Status: ${response.status}`);
            
            if (!response.ok) {
                let errorMsg = `Failed to load order`;
                
                if (response.status === 404) {
                    errorMsg = `Order #${orderId} not found. Please check your order ID.`;
                } else if (response.status === 401 || response.status === 403) {
                    errorMsg = 'Invalid or expired JWT token. Please provide a valid token.';
                } else if (response.status === 500) {
                    errorMsg = 'Server error. Please try again later.';
                }
                
                throw new Error(errorMsg);
            }
            
            currentOrder = await response.json();
            ORDER_ID = orderId;
            
            console.log('‚úÖ Order loaded successfully:', currentOrder);
            
            // Display order details
            displayOrderDetails(currentOrder);
            
            // Show payment section
            document.getElementById('order-input-section').style.display = 'none';
            orderDetailsDisplay.style.display = 'block';
            document.getElementById('payment-section').style.display = 'block';
            document.getElementById('qclub-pay-btn').style.display = 'block';
            document.getElementById('qclub-info').style.display = 'block';
            loadingSection.style.display = 'none';
            
        } catch (error) {
            console.error('‚ùå Error loading order:', error);
            showError(error.message);
            loadBtn.disabled = false;
            loadBtn.textContent = 'Load Order';
            loadingSection.style.display = 'none';
        }
    }
    
    /**
     * Display order details
     */
    function displayOrderDetails(order) {
        const itemsList = document.getElementById('order-items-list');
        const totalAmount = document.getElementById('order-total-amount');
        
        if (!order.items || order.items.length === 0) {
            itemsList.innerHTML = '<p style="color: #697386; font-size: 14px;">No items in this order</p>';
            totalAmount.textContent = '$0.00';
            return;
        }
        
        let html = '';
        order.items.forEach(item => {
            const itemTotal = (item.price * item.quantity).toFixed(2);
            html += `
                <div class="order-item">
                    <span>${item.product_id || item.name || 'Product'} (√ó${item.quantity})</span>
                    <span>$${itemTotal}</span>
                </div>
            `;
        });
        
        itemsList.innerHTML = html;
        totalAmount.textContent = `$${order.total_price.toFixed(2)}`;
    }
    
    /**
     * Create QClub payment session
     */
    async function createQClubPayment() {
        const payBtn = document.getElementById('qclub-pay-btn');
        const loadingSection = document.getElementById('loading');
        
        try {
            if (!jwtToken || !ORDER_ID || !currentOrder) {
                showError('Missing required information. Please start over.');
                return;
            }
            
            payBtn.disabled = true;
            payBtn.textContent = 'Creating Payment...';
            loadingSection.style.display = 'block';
            
            console.log('üí≥ Creating QClub payment for order:', ORDER_ID);
            
            const payload = {
                order_id: ORDER_ID,
                amount: currentOrder.total_price,
                currency: 'IQD',
                tip_amount: 0,
                metadata: {
                    return_url: window.location.href,
                    webhook_url: `${BACKEND_BASE_URL}/api/payments/qclub/webhook`
                }
            };
            
            console.log('üì§ Payload:', payload);
            
            const response = await fetch(`${API_BASE_URL}/payments/qclub/create-payment`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify(payload)
            });
            
            console.log(`üìä Response Status: ${response.status}`);
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to create payment');
            }
            
            const data = await response.json();
            console.log('‚úÖ Payment created:', data);
            
            if (!data.form_url) {
                throw new Error('No payment form URL received from server');
            }
            
            // Redirect to QClub payment form
            showSuccess('Redirecting to QClub payment form...');
            setTimeout(() => {
                window.location.href = data.form_url;
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå Error creating payment:', error);
            showError(error.message);
            payBtn.disabled = false;
            payBtn.textContent = 'Complete Payment with QClub';
            loadingSection.style.display = 'none';
        }
    }
    
    /**
     * Show error message
     */
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = `‚ö†Ô∏è ${message}`;
        errorDiv.style.display = 'block';
        
        // Scroll to error
        errorDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    /**
     * Show success message
     */
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = `‚úÖ ${message}`;
        successDiv.style.display = 'block';
    }
    
    // ========== PAGE INITIALIZATION ==========
    
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ QClub Payment Frontend Initialized');
        console.log('Backend URL:', BACKEND_BASE_URL);
        console.log('API Base URL:', API_BASE_URL);
        
        // JWT Token input handler
        const jwtInput = document.getElementById('jwt-token-input');
        jwtInput.addEventListener('input', handleJWTToken);
        jwtInput.addEventListener('paste', () => {
            setTimeout(handleJWTToken, 100);
        });
        
        // Load order button
        const loadBtn = document.getElementById('load-order-btn');
        const orderInput = document.getElementById('order-id-input');
        
        loadBtn.addEventListener('click', () => {
            if (!isAuthenticated) {
                showError('Please paste your JWT token first');
                return;
            }
            
            const orderId = parseInt(orderInput.value);
            
            if (!orderId || orderId <= 0) {
                showError('Please enter a valid order ID (must be a number greater than 0)');
                return;
            }
            
            loadOrderById(orderId);
        });
        
        // Allow Enter key to load order
        orderInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadBtn.click();
            }
        });
        
        // QClub payment button
        const qclubPayBtn = document.getElementById('qclub-pay-btn');
        qclubPayBtn.addEventListener('click', createQClubPayment);
    });
</script>

</body>
</html>
