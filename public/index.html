<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taken Cafe - Payment</title>
    <style>
        /* CSS STYLES */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f7f9fc; color: #333; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; width: 100%; max-width: 480px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 24px; color: #1a1f36; }
        .subtitle { color: #697386; margin-top: 5px; font-size: 14px; }
        
        /* Gateway Selection */
        .gateway-selector { margin-bottom: 30px; text-align: center; }
        .gateway-btn { 
            padding: 12px 24px; 
            margin: 0 10px; 
            border: 2px solid #e6ebf1; 
            background: white; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            transition: all 0.3s;
        }
        .gateway-btn.active {
            border-color: #5469d4;
            background: #5469d4;
            color: white;
        }
        .gateway-btn:hover { border-color: #5469d4; }
        
        .gateway-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fc;
            border-radius: 6px;
            font-size: 14px;
            color: #697386;
        }
        
        #loading { text-align: center; padding: 40px; }
        .spinner { 
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5469d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‚òï Taken Cafe</h1>
        <p class="subtitle">Secure Checkout</p>
    </header>

    <!-- Gateway Selector -->
    <section class="gateway-selector">
        <div>
            <button id="gateway-ngenius" class="gateway-btn active" onclick="selectGateway('ngenius')">
                üè¶ N-Genius (Default)
            </button>
            <button id="gateway-stripe" class="gateway-btn" onclick="selectGateway('stripe')">
                üí≥ Stripe
            </button>
        </div>
        <div class="gateway-info">
            <span id="gateway-info-text">Using Network International (N-Genius) for UAE payments</span>
        </div>
    </section>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading payment page...</p>
    </div>
</div>

<script>
    // Configuration
    const urlParams = new URLSearchParams(window.location.search);
    const BACKEND_BASE_URL = urlParams.get('backend_base_url') || 'http://localhost:8005';
    const ORDER_ID = urlParams.get('order_id') || '8';
    const DEFAULT_GATEWAY = urlParams.get('gateway') || 'ngenius';  // 'ngenius' or 'stripe'
    
    function selectGateway(gateway) {
        console.log('üè¶ Selected gateway:', gateway);
        
        // Update button states
        document.getElementById('gateway-ngenius').classList.toggle('active', gateway === 'ngenius');
        document.getElementById('gateway-stripe').classList.toggle('active', gateway === 'stripe');
        
        // Update info text
        const infoText = document.getElementById('gateway-info-text');
        if (gateway === 'ngenius') {
            infoText.textContent = 'Using Network International (N-Genius) for UAE payments';
        } else {
            infoText.textContent = 'Using Stripe for international payments';
        }
        
        // Redirect to appropriate payment page
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('gateway', gateway);
        
        if (gateway === 'ngenius') {
            window.location.href = `index-ngenius.html?order_id=${ORDER_ID}&backend_base_url=${encodeURIComponent(BACKEND_BASE_URL)}`;
        } else {
            window.location.href = `index-stripe.html?order_id=${ORDER_ID}&backend_base_url=${encodeURIComponent(BACKEND_BASE_URL)}`;
        }
    }
    
    // Auto-redirect based on default gateway
    window.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Payment Gateway Selector');
        console.log('Backend URL:', BACKEND_BASE_URL);
        console.log('Order ID:', ORDER_ID);
        console.log('Default Gateway:', DEFAULT_GATEWAY);
        
        // Auto-select default gateway after 2 seconds
        setTimeout(() => {
            selectGateway(DEFAULT_GATEWAY);
        }, 2000);
    });
</script>

</body>
</html>
    // =================================================

    // State Variables
    let stripe, elements, paymentElement;
    let currentOrder = null;
    let currentTipPercent = 15;
    let customTip = 0;
    let currentClientSecret = null;
    let updateTimer = null; // For debouncing tip updates

    // Initialize App
    document.addEventListener('DOMContentLoaded', async () => {
        console.log(`üöÄ Starting App. Connecting to: ${BACKEND_BASE_URL}`);
        
        try {
            stripe = Stripe(STRIPE_KEY);
            
            // Step 1: Load the Order
            await loadOrder();

            // Step 2: Initialize Stripe Payment Element (Requires fetching Intent first)
            await initializePaymentElement();

        } catch (error) {
            showError(`Initialization Failed: ${error.message}`);
        }
    });

    // --- FUNCTION: Load Order ---
    async function loadOrder() {
        try {
            // Use public endpoint that doesn't require authentication
            const res = await fetch(`${BACKEND_BASE_URL}/api/payments/public/order/${ORDER_ID}`);
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || `Order API returned ${res.status}`);
            }
            
            currentOrder = await res.json();
            console.log("‚úÖ Order Loaded:", currentOrder);
            
            renderOrderDetails();
            updateTotals();

            // Reveal UI
            document.getElementById('tip-section').style.display = 'block';
            document.getElementById('payment-section').style.display = 'block';

        } catch (err) {
            console.error(err);
            throw new Error(`Could not load order. Check console.`);
        }
    }

    // --- FUNCTION: Initialize Payment Element ---
    async function initializePaymentElement() {
        try {
            // We must create the PaymentIntent BEFORE mounting the element
            // because the Element needs the 'clientSecret' to know what methods to show.
            const clientSecret = await createOrUpdatePaymentIntent();
            
            const appearance = { theme: 'stripe' };
            elements = stripe.elements({ appearance, clientSecret });
            
            paymentElement = elements.create('payment', {
                layout: 'tabs' // Displays 'Apple Pay' and 'Card' as tabs if available
            });
            
            paymentElement.mount('#payment-element');
            
            // Attach submit listener
            document.getElementById('payment-form').addEventListener('submit', handleSubmit);

        } catch (error) {
            showError("Failed to load payment form: " + error.message);
        }
    }

    // --- FUNCTION: Create or Update Payment Intent ---
    // This calls your backend to get a clientSecret for the current total amount
    async function createOrUpdatePaymentIntent() {
        const subtotal = currentOrder.total_price;
        const tipAmount = (customTip > 0) ? customTip : (subtotal * currentTipPercent / 100);
        
        console.log(`Creating/Updating Intent for Tip: $${tipAmount}`);

        const res = await fetch(`${BACKEND_BASE_URL}/api/payments/intents`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                order_id: parseInt(ORDER_ID),
                currency: 'USD',
                tip_amount: tipAmount
            })
        });

        if (!res.ok) {
            const txt = await res.text();
            throw new Error(`Backend Error: ${txt}`);
        }

        const data = await res.json();
        currentClientSecret = data.client_secret;
        return data.client_secret;
    }

    // --- FUNCTION: Handle Payment Submission ---
    async function handleSubmit(e) {
        e.preventDefault();
        
        const btn = document.getElementById('pay-button');
        btn.disabled = true;
        btn.textContent = "Processing...";
        document.getElementById('error-container').style.display = 'none';

        if (!stripe || !elements) return;

        // Stripe confirms the payment using the element's data
        const { error, paymentIntent } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                // Return URL is required, but we can handle without redirect if we prefer:
                // If you want to avoid redirect, use redirect: 'if_required'
                return_url: window.location.href + '?status=success',
            },
            redirect: 'if_required' 
        });

        if (error) {
            console.error("Payment Error:", error);
            showError(error.message);
            btn.disabled = false;
            btn.textContent = "Pay Now";
        } else if (paymentIntent && paymentIntent.status === 'succeeded') {
            console.log("‚úÖ Payment Succeeded:", paymentIntent);
            
            // Record in backend (Optional if your webhook handles it, but good for UI)
            await recordSuccess(paymentIntent);
            showSuccess(paymentIntent.amount / 100, paymentIntent.id);
        }
    }

    // --- FUNCTION: Record Success ---
    async function recordSuccess(paymentIntent) {
        try {
            const tipAmount = (paymentIntent.amount / 100) - currentOrder.total_price;
            console.log(`Recording payment to backend: amount=${paymentIntent.amount / 100}, tip=${tipAmount}`);
            
            // Call the local Node.js payment route which forwards to the main backend API
            const response = await fetch(`/api/payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_id: parseInt(ORDER_ID),
                    payment_method: 'card', // Or 'apple_pay' if you can detect it
                    amount: currentOrder.total_price,
                    tip_amount: tipAmount,
                    currency: 'USD',
                    stripe_payment_intent_id: paymentIntent.id,
                    stripe_charge_id: paymentIntent.latest_charge
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("‚ùå Backend error:", response.status, errorText);
                return;
            }
            
            const result = await response.json();
            console.log("‚úÖ Payment recorded in backend:", result);
        } catch (err) {
            console.error("‚ùå Backend recording failed:", err);
        }
    }

    // --- HELPER: Tip Logic with Debounce ---
    // When tip changes, we must update the PaymentIntent on the server 
    // so Stripe knows the new total amount before the user pays.
    async function handleTipChange() {
        updateTotals();
        
        const btn = document.getElementById('pay-button');
        btn.disabled = true;
        btn.textContent = "Updating Total...";

        // Debounce: Wait 500ms after user stops clicking/typing
        clearTimeout(updateTimer);
        updateTimer = setTimeout(async () => {
            try {
                // Fetch new secret for new amount
                const newClientSecret = await createOrUpdatePaymentIntent();
                
                // Tell Stripe Elements to use the new secret
                // This updates the internal amount without reloading the UI
                elements.fetchUpdates(); 
                
                btn.disabled = false;
                btn.textContent = "Pay Now";
            } catch (error) {
                console.error("Failed to update tip:", error);
                showError("Could not update tip amount. Please refresh.");
            }
        }, 500);
    }

    window.setTip = function(percent) {
        currentTipPercent = percent;
        customTip = 0;
        document.getElementById('custom-tip').value = '';
        
        document.querySelectorAll('.tip-btn').forEach(btn => {
            if(btn.textContent.includes(percent + '%') || (percent===0 && btn.textContent==='No')) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        handleTipChange();
    }

    window.setCustomTip = function(val) {
        customTip = parseFloat(val) || 0;
        document.querySelectorAll('.tip-btn').forEach(b => b.classList.remove('active'));
        handleTipChange();
    }

    // --- HELPER: UI Logic ---
    function renderOrderDetails() {
        const container = document.getElementById('order-items-container');
        if (!currentOrder.items || currentOrder.items.length === 0) {
            container.innerHTML = '<p>No items in order.</p>';
            return;
        }
        let html = '';
        currentOrder.items.forEach(item => {
            html += `
            <div class="order-item">
                <span>${item.product_id} <span style="color:#8898aa">x${item.quantity}</span></span>
                <span>$${item.price.toFixed(2)}</span>
            </div>`;
        });
        container.innerHTML = html;
        document.getElementById('totals-container').style.display = 'block';
    }

    function updateTotals() {
        const subtotal = currentOrder.total_price;
        const tip = (customTip > 0) ? customTip : (subtotal * currentTipPercent / 100);
        const total = subtotal + tip;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('tip-amount').textContent = `$${tip.toFixed(2)}`;
        document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
    }

    function showError(msg) {
        const el = document.getElementById('error-container');
        el.style.display = 'block';
        el.innerHTML = `<strong>Error:</strong> ${msg}`;
    }

    function showSuccess(amount, id) {
        document.getElementById('checkout-view').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
        document.getElementById('receipt-info').innerHTML = `Amount Paid: $${amount.toFixed(2)}<br>Trans ID: ${id}`;
    }
</script>

</body>
</html>