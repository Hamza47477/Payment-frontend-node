<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taken Cafe - Payment</title>
    <style>
        /* CSS STYLES */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #f7f9fc; 
            color: #333; 
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            margin: 0; 
        }
        
        .container { 
            background: white; 
            width: 100%; 
            max-width: 480px; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        
        header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        
        h1 { 
            margin: 0; 
            font-size: 24px; 
            color: #1a1f36; 
        }
        
        .subtitle { 
            color: #697386; 
            margin-top: 5px; 
            font-size: 14px; 
        }
        
        /* Order Input Section */
        .order-input-section {
            text-align: center;
            padding: 20px 0;
        }
        
        .order-input-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #1a1f36;
        }
        
        .order-input-section input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e6ebf1;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        .order-input-section input:focus {
            outline: none;
            border-color: #5469d4;
            box-shadow: 0 0 0 3px rgba(84, 105, 212, 0.1);
        }
        
        .btn-primary {
            background: #5469d4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: #4053b8;
        }
        
        .btn-primary:disabled {
            background: #9ca9df;
            cursor: not-allowed;
        }
        
        /* Gateway Selection */
        .gateway-selector { 
            margin-bottom: 30px; 
            text-align: center; 
            display: none; 
        }
        
        .gateway-selector h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #1a1f36;
        }
        
        .gateway-btn { 
            padding: 12px 24px; 
            margin: 0 10px; 
            border: 2px solid #e6ebf1; 
            background: white; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .gateway-btn.active {
            border-color: #5469d4;
            background: #5469d4;
            color: white;
        }
        
        .gateway-btn:hover { 
            border-color: #5469d4; 
        }
        
        .gateway-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fc;
            border-radius: 6px;
            font-size: 14px;
            color: #697386;
        }
        
        /* Order Details Display */
        .order-details-display {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .order-details-display h3 {
            margin-top: 0;
            font-size: 16px;
            color: #1a1f36;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e6ebf1;
            font-size: 14px;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-weight: 600;
            font-size: 16px;
            color: #1a1f36;
            margin-top: 10px;
            border-top: 2px solid #e6ebf1;
        }
        
        #loading { 
            text-align: center; 
            padding: 40px; 
            display: none; 
        }
        
        .spinner { 
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5469d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‚òï Taken Cafe</h1>
        <p class="subtitle">Secure Checkout</p>
    </header>

    <!-- Error Message Display -->
    <div id="error-message" class="error-message"></div>
    
    <!-- Success Message Display -->
    <div id="success-message" class="success-message"></div>

    <!-- Order ID Input Section (First Step) -->
    <section id="order-input-section" class="order-input-section">
        <h2>Enter Your Order ID</h2>
        <input 
            type="number" 
            id="order-id-input" 
            placeholder="Order ID" 
            min="1" 
            autocomplete="off"
        />
        <button id="load-order-btn" class="btn-primary">Load Order</button>
    </section>

    <!-- Order Details Preview -->
    <div id="order-details-display" class="order-details-display">
        <h3>Order Summary</h3>
        <div id="order-items-list"></div>
        <div class="order-total">
            <span>Total Amount:</span>
            <span id="order-total-amount">$0.00</span>
        </div>
    </div>

    <!-- Gateway Selector (Second Step) -->
    <section id="gateway-selector" class="gateway-selector">
        <h2>Select Payment Gateway</h2>
        <div>
            <button id="gateway-ngenius" class="gateway-btn active" onclick="selectGateway('ngenius')">
                üè¶ N-Genius Payment
            </button>
            <button id="gateway-stripe" class="gateway-btn" onclick="selectGateway('stripe')">
                üí≥ Stripe Payment
            </button>
        </div>
        <div class="gateway-info">
            <span id="gateway-info-text">Using Network International (N-Genius) for UAE payments</span>
        </div>
    </section>

    <!-- Loading Indicator -->
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">Loading payment page...</p>
    </div>
</div>

<script>
    // ========== CONFIGURATION ==========
    const BACKEND_BASE_URL = 'https://livekit-mobile.linkedinwriter.io';
    const API_BASE_URL = `${BACKEND_BASE_URL}/api`;
    const DEFAULT_GATEWAY = 'ngenius';
    
    // ========== STATE VARIABLES ==========
    let currentOrder = null;
    let ORDER_ID = null;
    let currentOrder = null;
    let ORDER_ID = null;
    
    // ========== MAIN FUNCTIONS ==========
    
    /**
     * Load order details from backend API
     * Fetches order from /api/orders/{orderId} endpoint
     */
    async function loadOrderById(orderId) {
        const loadingSection = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const loadBtn = document.getElementById('load-order-btn');
        const orderDetailsDisplay = document.getElementById('order-details-display');
        
        try {
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            loadingSection.style.display = 'block';
            errorDiv.style.display = 'none';
            
            console.log(`üîç Fetching order ${orderId} from ${API_BASE_URL}/orders/${orderId}`);
            
            // Fetch order from backend
            const response = await fetch(`${API_BASE_URL}/orders/${orderId}`);
            
            if (!response.ok) {
                let errorMsg = `Failed to load order`;
                
                if (response.status === 404) {
                    errorMsg = `Order #${orderId} not found. Please check your order ID.`;
                } else if (response.status === 403) {
                    errorMsg = 'Access denied to this order.';
                } else if (response.status === 500) {
                    errorMsg = 'Server error. Please try again later.';
                }
                
                throw new Error(errorMsg);
            }
            
            currentOrder = await response.json();
            ORDER_ID = orderId;
            
            console.log('‚úÖ Order loaded successfully:', currentOrder);
            
            // Display order details
            displayOrderDetails(currentOrder);
            
            // Hide input section, show gateway selector and order details
            document.getElementById('order-input-section').style.display = 'none';
            orderDetailsDisplay.style.display = 'block';
            document.getElementById('gateway-selector').style.display = 'block';
            loadingSection.style.display = 'none';
            
            // Auto-redirect to payment page after 2 seconds
            setTimeout(() => {
                selectGateway(DEFAULT_GATEWAY);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Error loading order:', error);
            errorDiv.textContent = `‚ö†Ô∏è ${error.message}`;
            errorDiv.style.display = 'block';
            loadBtn.disabled = false;
            loadBtn.textContent = 'Load Order';
            loadingSection.style.display = 'none';
        }
    }
    
    /**
     * Display order details in the preview section
     */
    function displayOrderDetails(order) {
        const itemsList = document.getElementById('order-items-list');
        const totalAmount = document.getElementById('order-total-amount');
        
        if (!order.items || order.items.length === 0) {
            itemsList.innerHTML = '<p style="color: #697386; font-size: 14px;">No items in this order</p>';
            totalAmount.textContent = '$0.00';
            return;
        }
        
        let html = '';
        order.items.forEach(item => {
            const itemTotal = (item.price * item.quantity).toFixed(2);
            html += `
                <div class="order-item">
                    <span>${item.product_id || item.name || 'Product'} (√ó${item.quantity})</span>
                    <span>$${itemTotal}</span>
                </div>
            `;
        });
        
        itemsList.innerHTML = html;
        totalAmount.textContent = `$${order.total_price.toFixed(2)}`;
    }
    
    /**
     * Select payment gateway and redirect
     */
    function selectGateway(gateway) {
        console.log('üè¶ Selected gateway:', gateway);
        
        if (!ORDER_ID) {
            console.error('‚ùå No order ID set');
            return;
        }
        
        // Update button states
        document.getElementById('gateway-ngenius').classList.toggle('active', gateway === 'ngenius');
        document.getElementById('gateway-stripe').classList.toggle('active', gateway === 'stripe');
        
        // Update info text
        const infoText = document.getElementById('gateway-info-text');
        if (gateway === 'ngenius') {
            infoText.textContent = 'Using Network International (N-Genius) for UAE payments';
        } else {
            infoText.textContent = 'Using Stripe for international payments';
        }
        
        // Show loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading-text').textContent = `Redirecting to ${gateway === 'ngenius' ? 'N-Genius' : 'Stripe'} payment...`;
        
        // Redirect to appropriate payment page with order ID and backend URL
        setTimeout(() => {
            if (gateway === 'ngenius') {
                window.location.href = `index-ngenius.html?order_id=${ORDER_ID}&backend_base_url=${encodeURIComponent(BACKEND_BASE_URL)}`;
            } else {
                window.location.href = `index-stripe.html?order_id=${ORDER_ID}&backend_base_url=${encodeURIComponent(BACKEND_BASE_URL)}`;
            }
        }, 500);
    }
    
    /**
     * Show error message
     */
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = `‚ö†Ô∏è ${message}`;
        errorDiv.style.display = 'block';
    }
    
    /**
     * Show success message
     */
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = `‚úÖ ${message}`;
        successDiv.style.display = 'block';
    }
    
    // ========== PAGE INITIALIZATION ==========
    
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Payment Gateway Selector Initialized');
        console.log('Backend URL:', BACKEND_BASE_URL);
        console.log('API Base URL:', API_BASE_URL);
        
        // Check if order_id is in URL (coming back from payment page)
        const urlParams = new URLSearchParams(window.location.search);
        const orderIdFromUrl = urlParams.get('order_id');
        
        if (orderIdFromUrl) {
            console.log('üìã Found order ID in URL:', orderIdFromUrl);
            document.getElementById('order-id-input').value = orderIdFromUrl;
            loadOrderById(parseInt(orderIdFromUrl));
        }
        
        // Setup load button click handler
        const loadBtn = document.getElementById('load-order-btn');
        const orderInput = document.getElementById('order-id-input');
        
        loadBtn.addEventListener('click', () => {
            const orderId = parseInt(orderInput.value);
            
            if (!orderId || orderId <= 0) {
                showError('Please enter a valid order ID (must be a number greater than 0)');
                return;
            }
            
            loadOrderById(orderId);
        });
        
        // Allow Enter key to load order
        orderInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadBtn.click();
            }
        });
        
        // Clear error message when user starts typing
        orderInput.addEventListener('input', () => {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv.style.display === 'block') {
                errorDiv.style.display = 'none';
            }
        });
    });
</script>

</body>
</html>